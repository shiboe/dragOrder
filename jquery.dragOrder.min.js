/*
 * Drag Order - https://github.com/shiboe/dragOrder
 * Version 1.3.0
 * 
 * A simple script for implementing a dragable ordering interface.
 * 
 * $(element).dragOrder({options});
 * 
 * Developed by [Stephen Cave](sccave@gmail.com) @ [shiboe.com](http://shiboe.com) Copyright 2012.
 * [Licensed under the MIT License](http://opensource.org/licenses/mit-license.php)
 * 
 */

(function($){var methods={init:function(options,callback){var settings=$.extend({"vertical":false,"catchThreshold":3,"moveStyles":".dragContainer","callbackStringDelimiter":false},options);return this.each(function(){build(this,settings,callback);var data=$(this).data("dragOrder");if(!data){$(this).data('dragOrder',{'settings':settings,'callback':callback})}})},destroy:function(){return this.each(function(){})}};$.fn.dragOrder=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments)}else{$.error('Method '+method+' does not exist on jQuery.dragOrder')}};function build(container,settings,callback){$(container).children().each(function(){var w=$(this).outerWidth(),h=$(this).outerHeight(),margins={l:$(this).css("marginLeft"),r:$(this).css("marginRight"),t:$(this).css("marginTop"),b:$(this).css("marginBottom")};$(this).wrap("<div class='dragContainer' style='width:"+w+"px; height:"+h+"px; margin-left:"+margins.l+"; margin-right:"+margins.r+"; margin-top:"+margins.t+"; margin-bottom:"+margins.b+";' />")});$(container).children(".dragContainer").each(function(){if(!settings.vertical)$(this).addClass("horizontal");$(this).on("mousedown.dragOrder",function(e){if(e.which==1){e.preventDefault();catchDrag(this,settings,e.pageY,e.pageX,callback)}});this.setAttribute("data-order-index",$(this).index())});if(settings.vertical)$(container).addClass("vertical");$(container).find(settings.moveStyles).addClass("moveStyles");if(typeof callback=="function")callback.call(this,order(container,settings.callbackStringDelimiter))}function order(container,delimiteredString){var order=[];$(".dragContainer",container).each(function(){order.push(this.getAttribute('data-order-index'))});if(typeof delimiteredString=="undefined"||delimiteredString===false)return order;else return order.join(delimiteredString)}function catchDrag(element,settings,y,x,callback){$(window).on("mousemove.dragOrder_catch",function(e){if(Math.abs(e.pageY-y)>settings.catchThreshold||Math.abs(e.pageX-x)>settings.catchThreshold){$(window).off("mousemove.dragOrder_catch").off("mouseup.dragOrder_catch");dragging(element,settings,e.pageY,e.pageX,callback)}}).on("mouseup.dragOrder_catch",function(e){$(window).off("mousemove.dragOrder_catch").off("mouseup.dragOrder_catch")})}function dragging(element,settings,y,x,callback){var newElement=$(element).clone(true).appendTo("body").addClass("moving").css("position","absolute").append("<div class='moveIndex'></div>"),newElementCenterOffset={y:y-$(element).offset().top,x:x-$(element).offset().left},hotzones=[],newPos=-1,oldPos=$(element).index(),siblings=$(element).siblings(".dragContainer"),container=$(element).parent();$(element).addClass("moved");if(settings.vertical){siblings.each(function(){var thisPos=$(this).index(),thisOffset=$(this).offset(),thisMargin={top:parseFloat($(this).children().css("marginTop")),bottom:parseFloat($(this).children().css("marginBottom"))},littleExtra=thisMargin.top>thisMargin.bottom?thisMargin.top/2:thisMargin.bottom/2;if(thisPos>oldPos)thisPos--;hotzones.push({x:thisOffset.left,y:thisOffset.top-littleExtra,x2:thisOffset.left+($(this).width()),y2:thisOffset.top+($(this).height()/2),newPos:thisPos,replacing:thisPos});hotzones.push({x:thisOffset.left,y:thisOffset.top+($(this).height()/2),x2:thisOffset.left+$(this).width(),y2:thisOffset.top+$(this).height()+littleExtra,newPos:thisPos+1,replacing:thisPos})})}else{siblings.each(function(){var thisPos=$(this).index(),thisOffset=$(this).offset(),thisMargin={left:parseFloat($(this).children().css("marginLeft")),right:parseFloat($(this).children().css("marginRight"))},littleExtra=thisMargin.left>thisMargin.right?thisMargin.left/2:thisMargin.right/2;if(thisPos>oldPos)thisPos--;hotzones.push({x:thisOffset.left-littleExtra,y:thisOffset.top,x2:thisOffset.left+($(this).width()/2),y2:thisOffset.top+$(this).height(),newPos:thisPos,replacing:thisPos});hotzones.push({x:thisOffset.left+($(this).width()/2),y:thisOffset.top,x2:thisOffset.left+$(this).width()+littleExtra,y2:thisOffset.top+$(this).height(),newPos:thisPos+1,replacing:thisPos})})}$(window).on("mousemove.dragOrder",function(e){$(newElement).css({"top":e.pageY-newElementCenterOffset.y,"left":e.pageX-newElementCenterOffset.x});var hot=false,updateDisplay=newPos>=0?newPos+1:"-";$(newElement).data("index",newPos).children(".moveIndex").html(updateDisplay);for(var i=0;i<hotzones.length;i++){if(e.pageX>=hotzones[i].x&&e.pageX<=hotzones[i].x2&&e.pageY>=hotzones[i].y&&e.pageY<=hotzones[i].y2){hot=true;var replacing=hotzones[i].replacing;newPos=hotzones[i].newPos;siblings.removeClass("sidleBack sidleForward");if(replacing==newPos)siblings.eq(replacing).addClass("sidleForward");else siblings.eq(replacing).addClass("sidleBack")}}if(!hot){newPos=-1;siblings.removeClass("sidleBack sidleForward")}}).on("mouseup.dragOrder",function(e){$(window).off("mousemove.dragOrder").off("mouseup.dragOrder");siblings.removeClass("sidleBack sidleForward");$(newElement).removeClass("moving").css({"top":"","left":"","position":"relative"}).children(".moveIndex").remove();var preceeding=siblings.eq(newPos-1),noAction=false;if(newPos>0)$(newElement).insertAfter(preceeding);else if(newPos==0)$(newElement).prependTo(container);else{noAction=true;$(newElement).remove();$(element).removeClass("moved")}if(!noAction)$(element).remove();if(typeof callback=="function")callback.call(this,order(container,settings.callbackStringDelimiter))})}})($);